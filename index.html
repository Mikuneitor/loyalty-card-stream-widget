<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tarjeta de lealtad</title>
  <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0; padding: 0;
      background: transparent;
    }
    .card {
      width: 85mm;
      height: 55mm;
      background: #f2e7dd;
      border: 4px solid #7a5e4a;
      border-radius: 32px;
      box-sizing: border-box;
      position: relative;
      font-family: 'Lilita One', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      overflow: hidden;
    }
    .title-row {
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      margin-top: 8mm;
      margin-bottom: 2.5mm;
      position: relative;
      z-index: 1;
    }
    .star-solid {
      display: inline-block;
      width: 7mm;
      height: 7mm;
      margin: 0 7mm;
      vertical-align: middle;
    }
    .title {
      color: #7a5e4a;
      font-size: 5.7mm;
      font-weight: bold;
      text-align: center;
      letter-spacing: 0.5px;
      line-height: 1;
      margin: 0 2.5mm;
      white-space: nowrap;
      z-index: 1;
      text-shadow: 0 1px 0 #fff4, 0 1px 4px #c9b4a0aa;
    }
    .stamps-container {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 2.3mm;
      margin: 0;
    }
    .stamps-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 3.6mm;
      margin: 0;
    }
    .stamp {
      width: 12mm;
      height: 12mm;
      background: #dab89c;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      transition: background 0.2s;
      box-shadow: 0 1.2px 4px #9f8e7a33;
      position: relative;
      z-index: 1;
      filter: none;
      border: none;
      overflow: visible;
    }
    .stamp.special {
      background: #c4887a; /* color rojizo último sello, siempre */
    }
    .stamp.marked:not(.special) {
      background: #c4887a;
      animation: pop 0.18s cubic-bezier(.2,.7,.6,1.4);
      box-shadow: 0 0 0 1mm #c4887a22, 0 2px 6px #9f8e7a22;
    }
    .stamp.special.marked {
      /* el último, si está marcado, tiene además brillo dorado */
      animation: pop 0.20s cubic-bezier(.2,.7,.6,1.4), finalglow 0.85s cubic-bezier(.8,.6,.4,1.2) infinite alternate;
      box-shadow: 0 0 13px 5px #ffd47a99, 0 0 22px 7px #fffbe0bb, 0 0 0 1.2mm #c4887a22;
      border: 2px solid #ffe8a9;
    }
    /* Efecto tinta */
    .stamp .ink {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 2;
      opacity: 0;
      animation: ink-splash 0.22s cubic-bezier(.2,.7,.6,1.4) forwards;
    }
    @keyframes ink-splash {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2);}
      25% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.11);}
      80% { opacity: 0.7; }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.18);}
    }
    @keyframes pop {
      0% { transform: scale(0.8);}
      70% { transform: scale(1.13);}
      100% { transform: scale(1);}
    }
    @keyframes finalglow {
      0% { box-shadow: 0 0 13px 5px #ffd47a99, 0 0 22px 7px #fffbe0bb, 0 0 0 1.2mm #c4887a22;}
      100% { box-shadow: 0 0 18px 10px #ffd700bb, 0 0 32px 10px #fff9c088, 0 0 0 1.5mm #c4887a22;}
    }
    @media (max-width: 600px) {
      .card { width: 320px; height: 208px;}
      .star-solid { width: 25px; height: 25px;}
      .title { font-size: 22px;}
      .stamp { width: 38px; height: 38px;}
      .stamps-row { gap: 10px;}
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title-row">
      <!-- Estrella sólida 4 puntas izquierda -->
      <span class="star-solid" style="margin-right:-1.1mm;">
        <svg width="100%" height="100%" viewBox="0 0 40 40" fill="#7a5e4a">
          <polygon points="20,4 24,16 36,20 24,24 20,36 16,24 4,20 16,16" />
        </svg>
      </span>
      <span class="title">Tarjeta de lealtad</span>
      <!-- Estrella sólida 4 puntas derecha -->
      <span class="star-solid" style="margin-left:-1.1mm;">
        <svg width="100%" height="100%" viewBox="0 0 40 40" fill="#7a5e4a">
          <polygon points="20,4 24,16 36,20 24,24 20,36 16,24 4,20 16,16" />
        </svg>
      </span>
    </div>
    <div class="stamps-container" id="stamps-container"></div>
  </div>
  <script>
    // CONFIGURACIÓN StreamElements
    const JWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjaXRhZGVsIiwiZXhwIjoxNzc0OTgyMTU3LCJqdGkiOiJmM2ZhNDQ1Yy00ZjRkLTQ4OWYtYjhiMy00YTUzN2RiZDhlNzciLCJjaGFubmVsIjoiNjBlZDc4MTgyMmZiMWI0ZjVjMWRhYzI5Iiwicm9sZSI6Im93bmVyIiwiYXV0aFRva2VuIjoiSVFpd2J0MGg0bzBBOGVZQWlfY1I4MXV6ZVZnMjZkb0U4YmtjRFJ4aUxkWlZiaTQ2IiwidXNlciI6IjYwZWQ3ODE4MjJmYjFiODYyNjFkYWMyOCIsInVzZXJfaWQiOiIyNDdmMzZhZC05MzAwLTRmNWMtYmMzNy0yNWQxNmYwZTZlOTkiLCJ1c2VyX3JvbGUiOiJjcmVhdG9yIiwicHJvdmlkZXIiOiJ0d2l0Y2giLCJwcm92aWRlcl9pZCI6IjY5NjE3MjA4NCIsImNoYW5uZWxfaWQiOiI4ZmQ5YzdmYy1hYzRkLTQ5MWYtODI5MS00NGNmNjRiZDU5NmIiLCJjcmVhdG9yX2lkIjoiNmMwODY0NGItZjk2NC00MTk1LThiZjktMGE2ZmRiOTFmMmJlIn0.gFUvm8TE6wI6m47S5OIsKU4vM97RYqKysKcUvu_Z0F0';
    const CHANNEL_ID = '60ed781822fb1b4f5c1dac29';

    const TOTAL_SELLOS = 10;
    const PUNTOS_POR_SELLO = 1;

    // Estructura en dos filas de 5 columnas
    const filas = 2;
    const columnas = 5;

    let prevActivos = 0;

    function inkSplashSVG() {
      return `<svg class="ink" width="13" height="13" viewBox="0 0 13 13">
        <ellipse cx="6.5" cy="6.5" rx="4" ry="1.5" fill="#a86c5e" fill-opacity="0.21"/>
        <ellipse cx="3.1" cy="5" rx="0.8" ry="0.4" fill="#a86c5e" fill-opacity="0.14"/>
        <ellipse cx="10" cy="8" rx="1.1" ry="0.35" fill="#a86c5e" fill-opacity="0.15"/>
        <ellipse cx="8.7" cy="2.8" rx="0.38" ry="0.16" fill="#a86c5e" fill-opacity="0.13"/>
        <ellipse cx="5.2" cy="11" rx="0.5" ry="0.2" fill="#a86c5e" fill-opacity="0.13"/>
      </svg>`;
    }

    function renderStamps(activos) {
      const container = document.getElementById('stamps-container');
      container.innerHTML = '';
      let count = 0;
      for (let f = 0; f < filas; f++) {
        const row = document.createElement('div');
        row.className = 'stamps-row';
        for (let c = 0; c < columnas; c++) {
          count++;
          const div = document.createElement('div');
          // El último sello siempre tiene la clase "special" (color diferente)
          div.className = 'stamp' + (count === TOTAL_SELLOS ? ' special' : '');
          row.appendChild(div);

          // Si marcado, añade clase y animación pop+ink
          if(count <= activos) {
            setTimeout(() => {
              if(count === TOTAL_SELLOS && activos === TOTAL_SELLOS) {
                div.classList.add('marked', 'final-glow', 'special');
              } else if(count === TOTAL_SELLOS) {
                div.classList.add('marked', 'special');
              } else {
                div.classList.add('marked');
              }
              if(count > prevActivos) {
                div.insertAdjacentHTML('beforeend', inkSplashSVG());
                setTimeout(()=> {
                  const ink = div.querySelector('.ink');
                  if(ink) ink.remove();
                }, 300);
              }
            }, 55 * (count - prevActivos)); // efecto en cadena
          }
        }
        container.appendChild(row);
      }
      prevActivos = activos;
    }

    // --- INTEGRACIÓN STREAMELEMENTS ---
    function getUserFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('user') || 'NOMBRE_USUARIO';
    }
    const username = getUserFromUrl().toLowerCase();

    async function getUserPoints() {
      const userInfo = await fetch(`https://api.streamelements.com/kappa/v2/users/${username}`).then(r => r.json());
      const userId = userInfo._id;
      if (!userId) return 0;

      const res = await fetch(`https://api.streamelements.com/kappa/v2/points/${CHANNEL_ID}/${userId}`, {
        headers: { 'Authorization': `Bearer ${JWT}` }
      });
      if (!res.ok) return 0;
      const data = await res.json();
      return data.points || 0;
    }

    async function update() {
      const points = await getUserPoints();
      const sellosActivos = Math.min(TOTAL_SELLOS, Math.floor(points / PUNTOS_POR_SELLO));
      renderStamps(sellosActivos);
    }

    setInterval(update, 5000);
    update();
  </script>
</body>
</html>
